#! /bin/bash
# Print ktlint reports in IDEA 

run_ktlint() {
  local gradlew_dir
  gradlew_dir=$(find_gradlew_dir)

  if [ -n "$gradlew_dir" ]; then
    echo "Running ktlint..."
    "$gradlew_dir/gradlew" --project-dir "$gradlew_dir" ktlintCheck --daemon > /dev/null 2>&1
  else
    echo "gradlew not found" >&2
    return 1
  fi
}

find_gradlew_dir() {
  local dir
  dir=$(pwd)
  while [ "$dir" != "/" ]; do
    if [ -x "$dir/gradlew" ]; then
      echo "$dir"
      return
    fi
    dir=$(dirname "$dir")
  done
}

print_reports() {
  find . -type f -path "*/build/reports/ktlint/*" -print0 | while read -r -d '' file; do
    [ -s "$file" ] || continue

    local extension
    extension="${file##*.}"

    if [ "$extension" == "json" ]; then
      print_json_report "$file"
    else
      cat "$file"
    fi
  done
}

print_json_report() {
  local file="$1"
  if command -v jq &> /dev/null; then
    if jq -e '. | length > 0' "$file" > /dev/null 2>&1; then
      jq . "$file"
    fi
  else
    if ! grep -q "^\[\]$" "$file"; then
      cat "$file"
    fi
  fi
}

main() {
  if [ "$1" = "-r" ] || [ "$1" = "--run"]; then
    run_ktlint
  fi

  print_reports
}

main "$@"
